<!-- Generated PVP Result Partial -->
<div class="space-y-6" x-data="{
    editing: false,
    showSendModal: false,
    sending: false,
    sendStatus: '',
    recipientEmail: '{% if profile.email %}{{ profile.email }}{% endif %}',
    recipientName: '{% if profile.name %}{{ profile.name }}{% endif %}',
    subject: 'Partnership Opportunity',
    async sendEmail() {
        this.sending = true;
        this.sendStatus = '';

        const formData = new FormData();
        formData.append('to_email', this.recipientEmail);
        formData.append('to_name', this.recipientName);
        formData.append('subject', this.subject);
        formData.append('body', document.querySelector('#pvp-result .whitespace-pre-wrap').textContent);
        formData.append('pvp_id', '{{ pvp.pk }}');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const response = await fetch('{% url \"outreach:send_email\" %}', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.method === 'mailto') {
                // No connected email - open mailto link
                window.location.href = data.mailto_link;
                this.sendStatus = 'Opening email client...';
                setTimeout(() => { this.showSendModal = false; }, 1500);
            } else if (data.success) {
                this.sendStatus = 'Email sent successfully!';
                setTimeout(() => { this.showSendModal = false; }, 2000);
            } else {
                this.sendStatus = 'Error: ' + (data.error || 'Failed to send');
                if (data.mailto_link) {
                    setTimeout(() => { window.location.href = data.mailto_link; }, 1000);
                }
            }
        } catch (error) {
            this.sendStatus = 'Error: ' + error.message;
        } finally {
            this.sending = false;
        }
    }
}">
    {% if is_general %}
    <!-- General Template Badge -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
        <div class="flex items-center">
            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span class="text-sm font-medium text-blue-800">General Template</span>
        </div>
        <p class="text-xs text-blue-600 mt-1">This template includes [PLACEHOLDERS] you can customize for each partner.</p>
    </div>
    {% endif %}

    <!-- Quality Score Badge -->
    <div class="flex items-center justify-between">
        <div class="flex items-center">
            <span class="text-sm font-medium text-gray-700 mr-2">Quality Score:</span>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                         {% if pvp.quality_score >= 80 %}bg-green-100 text-green-800
                         {% elif pvp.quality_score >= 60 %}bg-yellow-100 text-yellow-800
                         {% else %}bg-red-100 text-red-800{% endif %}">
                {{ pvp.quality_score|floatformat:0 }}/100
            </span>
        </div>
        <button @click="editing = !editing"
                class="text-sm text-primary-600 hover:text-primary-700 font-medium">
            <span x-text="editing ? 'Cancel' : 'Edit'"></span>
        </button>
    </div>

    <!-- Quality Breakdown -->
    <div class="bg-gray-50 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-700 mb-3">Quality Breakdown</h4>
        <div class="grid grid-cols-2 gap-2 text-xs">
            {% for criterion, data in quality_breakdown.items %}
            <div class="flex items-center justify-between">
                <span class="text-gray-600 capitalize">{{ criterion|cut:"_" }}</span>
                <span class="font-medium text-gray-900">
                    {{ data.score }}/{{ data.max }}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- PVP Content -->
    <div x-show="!editing">
        <!-- Pain Point -->
        <div class="mb-4">
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Pain Point Addressed</label>
            <p class="text-sm text-gray-800">{{ pvp.pain_point_addressed }}</p>
        </div>

        <!-- Value Offered -->
        <div class="mb-4">
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Value Offered</label>
            <p class="text-sm text-gray-800">{{ pvp.value_offered }}</p>
        </div>

        <!-- Full Message -->
        <div class="mb-4">
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Full Message</label>
            <div class="bg-white border border-gray-200 rounded-lg p-4 text-sm text-gray-800 whitespace-pre-wrap">{{ pvp.full_message }}</div>
        </div>

        <!-- CTA -->
        <div class="mb-4">
            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Call to Action</label>
            <p class="text-sm text-gray-800">{{ pvp.call_to_action }}</p>
        </div>
    </div>

    <!-- Edit Form -->
    <form x-show="editing"
          x-cloak
          hx-post="{% url 'outreach:pvp_detail' pvp.pk %}"
          hx-target="#pvp-result"
          hx-swap="innerHTML">
        {% csrf_token %}

        <div class="space-y-4">
            <div>
                <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Full Message</label>
                <textarea name="full_message"
                          rows="8"
                          class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">{{ pvp.full_message }}</textarea>
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Pain Point Addressed</label>
                <input type="text"
                       name="pain_point_addressed"
                       value="{{ pvp.pain_point_addressed }}"
                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Value Offered</label>
                <input type="text"
                       name="value_offered"
                       value="{{ pvp.value_offered }}"
                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Call to Action</label>
                <input type="text"
                       name="call_to_action"
                       value="{{ pvp.call_to_action }}"
                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
            </div>

            <button type="submit"
                    class="w-full px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 text-sm font-medium">
                Save Changes
            </button>
        </div>
    </form>

    <!-- Actions -->
    <div class="flex space-x-3 pt-4 border-t border-gray-200">
        <button onclick="navigator.clipboard.writeText(document.querySelector('#pvp-result .whitespace-pre-wrap').textContent)"
                class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm font-medium">
            Copy to Clipboard
        </button>
        <button @click="showSendModal = true"
                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium flex items-center justify-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            Send Email
        </button>
        <a href="{% url 'outreach:pvp_detail' pvp.pk %}"
           class="flex-1 px-4 py-2 bg-primary-600 text-white text-center rounded-md hover:bg-primary-700 text-sm font-medium">
            View Details
        </a>
    </div>

    <!-- Send Email Modal -->
    <div x-show="showSendModal"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         aria-labelledby="modal-title"
         role="dialog"
         aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div x-show="showSendModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
                 @click="showSendModal = false"></div>

            <!-- Modal panel -->
            <div x-show="showSendModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">

                <div class="absolute top-0 right-0 pt-4 pr-4">
                    <button @click="showSendModal = false"
                            type="button"
                            class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Send Email
                        </h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Recipient Email *</label>
                                <input type="email"
                                       x-model="recipientEmail"
                                       required
                                       placeholder="partner@example.com"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Recipient Name</label>
                                <input type="text"
                                       x-model="recipientName"
                                       placeholder="John Doe"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Subject Line</label>
                                <input type="text"
                                       x-model="subject"
                                       placeholder="Partnership Opportunity"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                            </div>
                            <div class="bg-gray-50 rounded-md p-3">
                                <p class="text-xs text-gray-500 mb-1">Message Preview:</p>
                                <p class="text-sm text-gray-700 line-clamp-3">{{ pvp.full_message|truncatewords:30 }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Message -->
                <div x-show="sendStatus" x-cloak class="mt-4">
                    <div :class="sendStatus.includes('Error') ? 'bg-red-50 text-red-800' : 'bg-green-50 text-green-800'"
                         class="rounded-md p-3 text-sm">
                        <span x-text="sendStatus"></span>
                    </div>
                </div>

                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button @click="sendEmail()"
                            :disabled="sending || !recipientEmail"
                            type="button"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg x-show="sending" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-text="sending ? 'Sending...' : 'Send Email'"></span>
                    </button>
                    <button @click="showSendModal = false"
                            type="button"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>

                <!-- Info about mailto fallback -->
                <div class="mt-4 text-xs text-gray-500 text-center">
                    <p>If no email account is connected, your default email client will open.</p>
                    <a href="{% url 'outreach:email_settings' %}" class="text-primary-600 hover:text-primary-700">
                        Connect your email account &rarr;
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Info -->
    <div class="text-xs text-gray-500 mt-4 pt-4 border-t border-gray-200">
        {% if is_general %}
        <p>Type: <span class="font-medium text-blue-600">General Template</span></p>
        {% elif profile %}
        <p>Generated for: <span class="font-medium">{{ profile.name }}</span></p>
        {% endif %}
        <p>Pattern: <span class="font-medium">{{ pvp.get_pattern_type_display }}</span></p>
        <p>Model: <span class="font-medium">{{ pvp.ai_model_used }}</span></p>
    </div>
</div>
