{% extends "base.html" %}

{% block title %}{{ playbook.name }} - JV Matchmaker{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-start mb-8">
        <div>
            <a href="{% url 'playbook:list' %}" class="text-gray-500 hover:text-gray-700 text-sm flex items-center mb-4">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Playbooks
            </a>
            <h1 class="text-2xl font-semibold text-gray-900">{{ playbook.name }}</h1>
            <div class="flex items-center gap-4 mt-2">
                <span class="text-xs font-medium px-2 py-1 rounded-full
                    {% if playbook.size == 'small' %}bg-green-100 text-green-700
                    {% elif playbook.size == 'medium' %}bg-blue-100 text-blue-700
                    {% else %}bg-purple-100 text-purple-700{% endif %}">
                    {{ playbook.get_size_display }}
                </span>
                {% if playbook.launch_date %}
                <span class="text-gray-500 text-sm">
                    Launch: {{ playbook.launch_date|date:"M j, Y" }}
                </span>
                {% endif %}
            </div>
        </div>
        <button onclick="generateAll()"
                id="generate-btn"
                class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Generate All Content
        </button>
    </div>

    <!-- Phase Sections -->
    {% regroup plays by launch_play.get_phase_display as phase_list %}

    {% for phase in phase_list %}
    <div class="mb-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <span class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3 text-sm">
                {{ forloop.counter }}
            </span>
            {{ phase.grouper }}
            <span class="ml-2 text-sm font-normal text-gray-500">({{ phase.list|length }} plays)</span>
        </h2>

        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            {% for play in phase.list %}
            <div class="border-b border-gray-100 last:border-b-0" id="play-{{ play.pk }}">
                <div class="p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start gap-4">
                            <!-- Checkbox -->
                            <button onclick="toggleComplete({{ play.pk }})"
                                    class="mt-1 w-5 h-5 rounded border-2 flex items-center justify-center transition-colors
                                        {% if play.is_completed %}bg-green-500 border-green-500{% else %}border-gray-300 hover:border-primary-500{% endif %}">
                                {% if play.is_completed %}
                                <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                {% endif %}
                            </button>

                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-400">Play {{ play.launch_play.play_number }}</span>
                                    <h3 class="font-medium text-gray-900 {% if play.is_completed %}line-through text-gray-500{% endif %}">
                                        {{ play.launch_play.name }}
                                    </h3>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">{{ play.launch_play.purpose }}</p>

                                <!-- Psychology tag -->
                                <span class="inline-block mt-2 text-xs px-2 py-1 bg-amber-50 text-amber-700 rounded">
                                    {{ play.launch_play.psychology }}
                                </span>

                                {% if play.scheduled_date %}
                                <span class="inline-block mt-2 ml-2 text-xs px-2 py-1 bg-blue-50 text-blue-700 rounded">
                                    {{ play.scheduled_date|date:"M j" }}
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Expand button -->
                        <button onclick="toggleExpand({{ play.pk }})"
                                class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-5 h-5 transform transition-transform" id="expand-icon-{{ play.pk }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Expanded Content -->
                    <div id="expand-{{ play.pk }}" class="hidden mt-4 pt-4 border-t border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-xs font-medium text-gray-500 uppercase mb-2">Content Concept</h4>
                                <p class="text-sm text-gray-700">{{ play.launch_play.content_concept }}</p>
                            </div>
                            <div>
                                <h4 class="text-xs font-medium text-gray-500 uppercase mb-2">AHA Moment</h4>
                                <p class="text-sm text-gray-700 italic">"{{ play.launch_play.aha_moment }}"</p>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h4 class="text-xs font-medium text-gray-500 uppercase mb-2">Hook Inspirations</h4>
                            <div class="flex flex-wrap gap-2">
                                {% for hook in play.launch_play.hook_inspirations %}
                                <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">"{{ hook }}"</span>
                                {% endfor %}
                            </div>
                        </div>

                        {% if play.custom_content %}
                        <div class="mt-4 p-4 bg-primary-50 rounded-lg">
                            <h4 class="text-xs font-medium text-primary-700 uppercase mb-2">AI-Generated Content</h4>
                            <p class="text-sm text-gray-800">{{ play.custom_content }}</p>
                        </div>
                        {% endif %}

                        <div class="mt-4">
                            <h4 class="text-xs font-medium text-gray-500 uppercase mb-2">Soft CTA</h4>
                            <p class="text-sm text-gray-600">{{ play.launch_play.soft_cta }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
function toggleExpand(playId) {
    const content = document.getElementById('expand-' + playId);
    const icon = document.getElementById('expand-icon-' + playId);
    content.classList.toggle('hidden');
    icon.classList.toggle('rotate-180');
}

function toggleComplete(playId) {
    fetch(`/playbook/play/${playId}/complete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function generateAll() {
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';

    fetch(`/playbook/{{ playbook.pk }}/generate/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Generation failed: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> Generate All Content';
        }
    });
}
</script>
{% endblock %}
